---
title: "Introduction to openSTARS"
author: "Mira Kattwinkel"
date: "`r Sys.Date()`"
output:
  md_document:
    variant: markdown_github
vignette: >
  %\VignetteIndexEntry{Introduction to openSTARS}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r echo=FALSE}
knitr::opts_chunk$set(
  eval = T,
  collapse = TRUE,
  comment = "#>"
)
```

`openSTARS` is an open source implementation of the STARS toolbox (Peterson & Ver Hoef, 2014) using R and GRASS GIS.
It prepares the .ssn object needed for the SSN package.
A digital elevation model (DEM) is used to derive stream networks (in contrast to STARS that can clean an existing stream network). The reason for this is that existing stream networks (e.g. obtained as shape files) very often contain loops and dead ends that hinder building a valid topography for them.

For more information on STARS and SSN, see [their web page](http://www.fs.fed.us/rm/boise/AWAE/projects/SpatialStreamNetworks.shtml).

Peterson, E. E., & Ver Hoef, J. M. (2014). STARS: An ArcGIS Toolset Used to Calculate the Spatial Information Needed to Fit Spatial Statistical Models to Stream Network Data. J Stat Softw, 56(2), 1â€“17.

## Installation and loading
A functional installation of [GRASS GIS (>=7.0)](https://grass.osgeo.org/#) with installed add-ons [r.stream.basins](https://grass.osgeo.org/grass70/manuals/addons/r.stream.basins.html), [r.stream.distance](https://grass.osgeo.org/grass70/manuals/addons/r.stream.distance.html), [r.stream.order](https://grass.osgeo.org/grass70/manuals/addons/r.stream.order.html) and 
[r.hydrodem](https://grass.osgeo.org/grass70/manuals/addons/r.hydrodem.html) is needed.
These add-ons can be installed from within GRASS using the console and g.extension or in the GUI under 'Settings'/'Addons extensions'/'Install extensions from add-ons' under 'raster'.

**UPDATE!!**
```{r install, eval=FALSE}
install.packages("devtools")
devtools::install_github("edild/openSTARS")
library("openSTARS")
```

## Basic usage

### Initiate an ephemeral GRASS session
First, a GRASS session must be initiated:
```{r init_grass1}
library(openSTARS)
initGRASS(gisBase = "/usr/lib/grass72/",
          home = tempdir(),
          override = TRUE)
```

Alternatively, the path to a specific GRASS database directory and a Location name can be provided.
```{r init_grass2, eval = FALSE}
library(openSTARS)
initGRASS(gisBase = "/usr/lib/grass72/",
          home = tempdir(),
          gisDbase = "./GRASSDB",
          location = "test_openSTARS",
          remove_GISRC = T,
          override = TRUE)
```

### Setup GRASS and load data into GRASS
The path to the digital elevation model (DEM) and the observation sites must be
provided. Additionally, the path to a stream network, which can be burnt into the
DEM before extracting the streams, can be given.

First, `setup_grass_environment` prepares the GRASS environment by setting

 * the projection to that one of the observation sites or to an epsg code provided
 * the region to the extent of the DEM.
 
For more information on the concept of GRASS Locations, Mapsets etc. see the [GRASS GIS Quickstart](https://grass.osgeo.org/grass73/manuals/helptext.html).

```{r setup_grass, warning=FALSE, message=TRUE, results='hide'}
dem_path <- system.file("extdata", "nc", "elev_ned_30m.tif", package = "openSTARS")
sites_path <- system.file("extdata", "nc", "sites_nc.shp", package = "openSTARS")

setup_grass_environment(dem = dem_path, sites = sites_path)

gmeta()
```

Then, use `import_data` to import all data into GRASS (DEM, observations sites and optionally stream network)
```{r import_data, message=TRUE}
import_data(dem = dem_path, sites = sites_path)
```

The DEM is loaded into the GRASS database as raster map named `dem`, the sites as vector map named `sites_o` and the (optional) stream network as vector map named `streams_o`.
Here's how the data looks like:

```{r plot_data1, message=FALSE, results='hide', fig.width = 6, fig.height = 6}
dem <- readRAST("dem", ignore.stderr = TRUE)
sites <- readVECT("sites_o", ignore.stderr = TRUE)
plot(dem, col = terrain.colors(20))
cols <- colorRampPalette(c("blue", "red"))(length(sites$value))[rank(sites$value)]
points(sites, pch = 16, col = cols)
```

### Derive streams from DEM
Next, the streams should be derived from the DEM.
```{r derive_streams, results='hide', message=TRUE}
derive_streams()
```
An existing stream network (if provided to `import_data` before) can be burnt into the DEM to force the streams derived from the DEM to the existing one. Additionally, other specifications on how the streams shall be created can be provided (see `?derive_streams` and  [r.stream.extract](https://grass.osgeo.org/grass73/manuals/r.stream.extract.html) for details).

```{r derive_streams2, results='hide', message=TRUE, eval=FALSE}
derive_streams(burn = 10, accum_threshold = 1000)
```

```{r plot_data2, message=FALSE, warning=FALSE, results="hide", fig.width = 6, fig.height = 6}
dem <- readRAST("dem", ignore.stderr = TRUE)
streams <- readVECT("streams_v", ignore.stderr = TRUE)
plot(dem, col = terrain.colors(20))
lines(streams, col = "blue")
points(sites, pch = 16, col = cols)
```

### Check the network
Next, the stream network should be checked if there are stream segments with more than two inflows. This must be corrected because the .ssn object must not have such complex junctions. In the nc data set provided, there will be no complex junctions.

```{r compl_junctions}
cp <- check_compl_junctions()
if (cp)
  correct_compl_junctions()
```

### Prepare edges
Now, information needed for the .ssn object can be derived for the streams and stored in a new vector map `edges`.

```{r prep_edges, results='hide', message=FALSE, warning=FALSE}
calc_edges()
```

```{r edges}
edges <- readVECT("edges", ignore.stderr = TRUE)
head(edges@data, n=4)
```

`edges` now holds the derived network plus attributes needed for the .ssn object

* network identifier (netID)
* reach identifier (rid)
* stream segment length (length)
* distance from the source (sourceDist)
* upstream distance, i.e. distance from the outlet of the network to the outflow of the stream segment (upDist)
* total catchment area (H2OArea)
* reach contributing area (rcaArea)

The additional fields hold information about the network: 'next_str' is the 'stream' this segment flows into, 'prev_str01' and 'prev_str02' are the two segments that flow into this segment.

### Prepare sites
Often, survey sites do not lay exactly on the stream network (due to GPS imprecision, stream representation as lines, derivation of streams from a DEM, etc.). To assign an exact position of the sites on the network they are moved to the closest stream segment (snapped) using
[v.distance](https://grass.osgeo.org/grass73/manuals/v.distance.html). Additionally, attributes needed for .ssn object are assigned: 
```{r prep_sites, results='hide', message=FALSE, warning=FALSE}
calc_sites()
sites <- readVECT("sites", ignore.stderr = TRUE)
head(sites@data)
```

* point identifier (pid)
* location identifier (locID) 
* network identifier (netID)
* reach identifier of the edge segment the point lies on (rid)
* upstream distance (upDist), i.e. the distance to the network outlet calculated using [r.stream.distance](https://grass.osgeo.org/grass70/manuals/addons/r.stream.distance.html).
* distance ratio, i.e. the ratio of the distance from the outflow of the edge to the point along the edge and the total length of the edge segment (distRatio).

Additional fields hold information on the snapping: distance of the original site to the closest edge (dist), i.e. how far the point was moved, and the new x and y coordinates (xm, ym). The filed 'cat_edge' gives the 'cat' of the stream segment the point lies on (equivalent to 'rid').

```{r plot_data3, fig.width = 6, fig.height = 6}
dem <- readRAST("dem", ignore.stderr = TRUE)
sites <- readVECT("sites", ignore.stderr = TRUE)
sites_orig <- readVECT("sites_o", ignore.stderr = TRUE)
edges <- readVECT("edges", ignore.stderr = TRUE)
plot(dem, col = terrain.colors(20))
lines(edges, col = "blue")
points(sites_orig, pch = 21, cex=0.75, bg = "grey")
points(sites, pch = 20, col = "black")
```

### Prepare prediction sites
Prediction sites can be created along the streams. Either the distance between the sites must be provided (`dist`) or the approximate number of sites that shall be created (`nsites`). Additionally, the creation can be restricted to a certain networks (`netIDs`).

Similar as for the observation sites, attributes needed for .ssn object are assigned: 

* point identifier (pid)
* location identifier (locID) 
* network identifier (netID)
* reach identifier of the edge segment the point lies on (rid)
* upstream distance (upDist), i.e. the distance to the network outlet calculated using [r.stream.distance](https://grass.osgeo.org/grass70/manuals/addons/r.stream.distance.html).
* distance ratio, i.e. the ratio of the distance from the outflow of the edge to the point along the edge and the total length of the edge segment (distRatio).

The filed 'cat_edge' gives the 'cat' of the stream segment the point lies on (equivalent to 'rid').

```{r prep_pred_sites, results='hide', message=FALSE, warning=FALSE}
calc_prediction_sites(predictions = "preds", nsites = 100, netIDs = 15 )
```

```{r plot_data4, fig.width = 6, fig.height = 6}
dem <- readRAST("dem", ignore.stderr = TRUE)
sites <- readVECT("sites", ignore.stderr = TRUE)
pred_sites <- readVECT("preds", ignore.stderr = TRUE)
edges <- readVECT("edges", ignore.stderr = TRUE)
plot(dem, col = terrain.colors(20))
lines(edges, col = "blue")
points(sites, pch = 21, cex=0.75, bg = "grey")
points(pred_sites, pch = 20, col = "black")
head(pred_sites@data)
```

### Calculate attributes from raster maps
Attributes (i.e. predictor variables for the .ssn object) can be calculated for observation and prediction sites. There are two ways to calculates attributes: 

1. approximately as described in Peterson & Ver Hoef, 2014: STARS: An ARCGIS Toolset Used to Calculate the Spatial Information Needed to Fit Spatial Statistical Models to Stream Network Data. J. Stat. Softw., 56 (2).
1. exactly by intersecting the catchment of each point with raster maps;

For the approximate calculation, first attributes must be intersected with the sub-catchments of the stream segments and then they are calculated for each site based on the distance ratio of the point. Note that the sub-catchment area 'H2OArea' for each stream segment is calculated automatically in calc_edges.

```{r attributes_approx}
# calculates slope from DEM as an example attribute
execGRASS("r.slope.aspect", flags = c("overwrite","quiet"),
          parameters = list(
            elevation = "dem",
            slope = "slope"
          ))
# calculate average slope per sub-catchment of each stream segment
calc_attributes_edges(input_raster = "slope", stat = "mean",
                      attr_name = "avSlo", round_dig = 4, clean = T)
# calculate approx. catchment area and average slope per catchment of each site
calc_attributes_sites_approx(sites_map = "sites",
                             input_attr_name = "avSlo",
                             output_attr_name = "avSloA",
                             stat = "mean")
sites <- readVECT("sites", ignore.stderr = TRUE)
head(sites@data)
```

The exact calculation of attribute values for the total catchment of each point can take quite long (depending on the number of points) because for each point the total catchment is first delineated based on the DEM and then intersected with the raster map(s) provided. Note that if no raster map is provided the total catchment area for each point is calculated.


```{r attributes_exact}
# calculates slope from DEM as an example attribute
execGRASS("r.slope.aspect", flags = c("overwrite","quiet"),
          parameters = list(
            elevation = "dem",
            slope = "slope"
          ))
# calculate exact catchment area and average slope per catchment of each site
calc_attributes_sites_exact(sites_map = "sites", 
                            input_raster = "slope",
                            stat = "mean",
                            attr_name = "avSloE", 
                            round_dig = 4)
sites <- readVECT("sites", ignore.stderr = TRUE)
head(sites@data)
```

In both alternatives, the catchment area for each site is calculated automatically ('H2OAreaA' for `calc_attributes_sites_appox` and 'H2OArea' for `calc_attributes_sites_exact`).

### Write all files to an ssn folder
All files needed (edges, sites and optionally prediction sites) are written to the file path provided and can then be read in by the SSN package.

```{r export}
ssn_dir <- file.path(tempdir(), 'nc.ssn')
export_ssn(ssn_dir)
list.files(ssn_dir)
```

## Errors and warnings on WINDOWS systems
Most problems occur because GRASS, which is called by the openSTARS package functions via package rgrass7, cannot find certain files, i.e. because some path and system variables are not set. The easiest solution is to install a stand-alone version of GRASS, i.e. not within QGIS or OSGeo.

### Setting PATH and SYSTEM variables
Alternatively, the following PATH and system variables must be set correctly (examples below assume that GRASS was installed under QGIS). This can be done globally (see instructions in the internet how to set such variables in your specific Windows version) or temporarily in the R session as follows

*	Path to iconv.dll and other necessary *.dll files; this must be set before the initGRASS command: 
Sys.setenv(PATH = paste0("C:/Program Files/QGIS 2.18/bin", ";", Sys.getenv("PATH")))
*	System variable GRASS_PYTHON; this must be set after initGRASS:
Sys.setenv(GRASS_PYTHON="C:/Program Files/QGIS 2.18/bin/python.exe")
*	System variable PYTHONHOME; this must be set after initGRASS:
Sys.setenv(PYTHONHOME="C:/Program Files/QGIS 2.18/apps/Python27")
*	System variable GDAL_DATA; this must be set after initGRASS:
Sys.setenv(GDAL_DATA="C:/Program Files/QGIS 2.18/share/gdal")

```{r windows settings, eval = FALSE}
  # GRASS in QGIS installation
  #set Path; must be done BEFORE initGRASS
  Sys.setenv(PATH=paste0("C:/Program Files/QGIS 2.18/bin",";", Sys.getenv("PATH")))
  initGRASS(gisBase = "c:/Program Files/QGIS 2.18/apps/grass/grass-7.0.5", 
            home = tempdir(),
            gisDbase = "C:/GRASSDB"
           )
  # set System Variables; must be done AFTER initGRASS
  Sys.setenv(GRASS_PYTHON="C:/Program Files/QGIS 2.18/bin/python.exe")
  Sys.setenv(PYTHONHOME="C:/Program Files/QGIS 2.18/apps/Python27")
  Sys.setenv(GDAL_DATA="C:/Program Files/QGIS 2.18/share/gdal")
```

### Specific messages
**_Problem_** Popup window:

*The program can't start because iconv.dll is missing from your computer. Try reinstalling the program to fix this problem.*
And similar messages for other \*.dll files.

**_Solution_** Check, if the missing file(s) are somewhere â€˜closeâ€™ to the GRASS installation; e.g., if Grass was installed with QGIS, GRASS might be located under C:\Program Files\QGIS 2.18\apps\grass\grass-7.0.5\ and iconv.dll can be found in C:\Program Files\QGIS 2.18\bin. Set the PATH variable to the latter folder. (See instructions in the internet how to set the PATH variable in your specific Windows version.)

If this does not help, try a stand-alone installation of GRASS (<https://grass.osgeo.org/>). The missing dll files will then probably be located in a folder called 'extrabin' within the GRASS directory and will be found automatically.

\ 

**_Problem_** Popup window:

*The program can't start because libgrass_gis.7.2.0.dll is missing from your computer. Try reinstalling the program to fix this problem.*

**_Solution_** Close R (to close the GRASS session) and open GRASS, or open GRASS and select a different location than the one used in R. In GRASS go to 'Settings'/'Addons extension'/'Install extensions from addons' and (re-) install r.hydrodem which can be found under 'raster'.

\ 

**_Problem_** Popup window: 
*The program can't start because libgrass_dbmibase.7.2.0.dll is missing from your computer. Try reinstalling the program to fix this problem.*

**_Solution_** Close R (to close the GRASS session) and open GRASS or open GRASS and select a different location than the one used in R. In GRASS go to 'Settings'/'Addons extension'/'Install extensions from addons' and (re-) install r.stream.order which can be found under 'raster'.

\ 

**_Problem_** Popup window: 
*The program can't start because libgrass_vector.7.2.0.dll is missing from your computer. Try reinstalling the program to fix this problem.*

**_Solution_** Close R (to close the GRASS session) and open GRASS or open GRASS and select a different location than the one used in R. In GRASS go to 'Settings'/'Addons extension'/'Install extensions from addons' and (re-) install r.stream.basins which can be found under 'raster'.

\ 

**_Problem_** Popup window: 
*The program can't start because libgrass_segment.7.0.5.dll is missing from your computer. Try reinstalling the program to fix this problem.*

**_Solution_** Close R (to close the GRASS session) and open GRASS or open GRASS and select a different location than the one used in R. In GRASS go to 'Settings'/'Addons extension'/'Install extensions from addons' and (re-) install r.stream.distance which can be found under 'raster'. 

\ 

**_Problem_** Warning message in R console: 
*Datum* your_datum *not recognised by GRASS and no  parameters found*

E.g. your_datum =  North_American_1983_HARN

**_Solution_** Find a folder called 'gdal' containing files including coordinate_axis.csv â€˜closeâ€™ to or in the GRASS installation; e.g., if Grass was installed with QGIS, GRASS might be located under C:\Program Files\QGIS 2.18\apps\grass\grass-7.0.5\ and the folder gdal can be found in C:\Program Files\QGIS 2.18\share\gdal. Create a System Variable GDAL_DATA and set it to this path. (See instructions in the internet how to create and set the system variables in your specific Windows version.)

\ 

**_Problem_** Error and warning messages in R console: 
*ERROR 4: Unable to open EPSG support file gcs.csv. Try setting the GDAL_DATA environment variable to point to the directory containing EPSG csv files.
ERROR: Unable to translate EPSG code
Warning message: running command 'g.proj.exe -c epsg=your_code had status 1*

**_Solution_** Find a folder called 'gdal' containing files including coordinate_axis.csv â€˜closeâ€™ to or in the GRASS installation; e.g., if Grass was installed with QGIS, GRASS might be located under c:\Program Files\QGIS 2.18\apps\grass\grass-7.0.5\ and the folder gdal can be found in C:\Program Files\QGIS 2.18\share\gdal. Create a System Variable GDAL_DATA and set it to this path. (See instructions in the internet how to create and set the system variables in your specific Windows version.)

\ 

**_Problem_** Error in R console:
*Warning 1: Cannot find pcs.csv
Warning 1: Cannot find datum.csv or gdal_datum.csv
Warning 1: Cannot find ellipsoid.csv
Warning 1: Cannot find prime_meridian.csv*

**_Solution_** Find a folder called gdal containing files including coordinate_axis.csv â€˜closeâ€™ to or in the GRASS installation; e.g., if Grass was installed with QGIS, GRASS might be located under C:\Program Files\QGIS 2.18\apps\grass\grass-7.0.5\ and the folder gdal can be found in C:\Program Files\QGIS 2.18\share\gdal. Create a System Variable GDAL_DATA and set it to this path. (See instructions in the internet how to create and set the system variables in your specific Windows version.)


\  

**_Problem_** Error in R console:
*Error : XML content does not seem to be XML: The system cannot find the path specified.' In addition: Warning message: running command 'v.db.renamecolumn.bat --interface-description' had status 1 
Error in parseGRASS(cmd, legacyExec = legacyExec) :   v.db.renamecolumn not parsed*

**_Solution_** Find the file python.exe â€˜closeâ€™ to the GRASS installation; e.g., if Grass was installed with QGIS, GRASS might be located under C:\Program Files\QGIS 2.18\apps\grass\grass-7.0.5\ and the file python.exe can be found in C:\Program Files\QGIS 2.18\bin.  Create a System Variable GRASS_PYTHON and set it to the complete path of this file (e.g. C:/Program Files/QGIS 2.18/bin/python.exe). (See instructions in the internet how to create and set the system variables in your specific Windows version.)

\ 

**_Problem_** Error in R console:
*Error : XML content does not seem to be XML: 'ImportError: No module named site' In addition: Warning message: running command 'v.db.renamecolumn.bat --interface-description' had status 1 
Error in parseGRASS(cmd, legacyExec = legacyExec) : v.db.renamecolumn not parsed*

**_Solution_** Find the folder Python27 â€˜closeâ€™ to the GRASS installation; e.g., if Grass was installed with QGIS, GRASS might be located under C:\Program Files\QGIS 2.18\apps\grass\grass-7.0.5\ and the folder can be found in C:\Program Files\QGIS 2.18\apps\Python27\. Create a System Variable PYTHONHOME and set it this path. (See instructions in the internet how to create and set the system variables in your specific Windows version.)


## Messages you do not need to worry about
In the R console when using function `setup_grass_environment`:

```
Trying to open with OGRâ€¦ 
...succeeded.
Default region was updated to the new projection, but if you have multiple
mapsets `g.region -d` should be run in each to update the region from the
default
Projection information updated
```

It is the intention of this function is to update the projection.

\ 

In the R console when using function `correct_compl_junctions`:
```
WARNING: XX points found, but not requested to be exported. Verify 'type' parameter.
```

In this function, the streams are imported and exported during the processing. At one stage, only the lines are exported but no points. These points were created automatically when extracting the streams from the DEM but are not needed.

\ 

In various functions:
```
WARNING: Vector map <XX> already exists and will be overwritten
WARNING: Raster map <XX> already exists and will be overwritten
```

This happens if e.g. the function has already been executed in the same GRASS locations. Existing maps are overwritten and all changes that might have been conducted are lost. However, usually this is not a problem and everything can be reconstructed if needed by just executing all functions again. If maps  are manually changed they could be saved under a different name to prevent automatic overwriting.

\ 

In the R console when using function `calc_edges`:
```
WARNING: No features selected, nothing to edit
```

In this function, points that were created automatically when extracting the streams from the DEM but are not needed are deleted. This warning appears if `correct_compl_junctions` has been executed before and the points have already been deleted.

\ 

In the R console when using function `calc_sites`:
```
WARNING: Width for column XX set to 255 (was not specified by OGR), some strings may be truncated!
```
Or in `export_ssn`:
```
Warning 1: Field site_id of width 255 truncated to 254.
```

This message appears when maps are exported to ESRI shape files, which cannot handle attribute fields with more than 254 characters. Typically, there is no need to worry because all fields should be shorter anyway. If the original shape files contained large fields with e.g. notes or other text, they may be truncated in the exported files. 



